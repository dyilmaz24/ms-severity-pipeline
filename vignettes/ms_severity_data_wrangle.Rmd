---
title: "MS Severity Wrangling: Public Demo (Synthetic Data)"
author: "Defne Yilmaz"
date: "`r format(Sys.Date())`"
output:
  html_document:
    toc: true
    toc_depth: 3
    number_sections: true
params:
  seed: 42
---

```{r setup, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
set.seed(params$seed)

library(dplyr)
library(tidyr)
library(lubridate)
library(readr)
library(knitr)
library(kableExtra)
```

# 1. Purpose & Safety Notes
This vignette demonstrates how to wrangle MS severity measures and covariates **using synthetic data only**.  
- Map **MS20** (survey response) to **EDSS categories**
- Compute **disease duration** and demo a **MSSS** lookup (example bins)
- Assemble cognitive scores (**SDMT**, **CVLT Total**)
- Recode covariates (**smoking**, **income**, **education**, **employment**, **relapse**, **race**, **sex**)
- Produce a clean analysis-ready dataset

> **Privacy/IP:** No real datasets, paths, or identifiers are used here. The MSSS table is represented in **truncated demo form** solely for illustration.  
> **Cite:** Roxburgh RH, et al. *Brain*. 2005;128(2):289â€“303.

---

# 2. Helper Functions (EDSS/MSSS & Recodes)
```{r helpers}
edss_from_ms20 <- function(ms20) {
  edss_label <- dplyr::case_when(
    ms20 == 0 ~ "<3",
    ms20 == 1 ~ "3-5.5",
    ms20 == 2 ~ "6",
    ms20 == 3 ~ "7",
    TRUE ~ NA_character_
  )
  edss_low  <- dplyr::case_when(edss_label == "<3" ~ 0,
                                edss_label == "3-5.5" ~ 3,
                                TRUE ~ NA_real_)
  edss_high <- dplyr::case_when(edss_label == "<3" ~ 2.5,
                                edss_label == "3-5.5" ~ 5.5,
                                TRUE ~ NA_real_)
  tibble(edss_label, edss_low, edss_high)
}

msss_from_edss_duration <- function(edss, duration_years) {
  brks <- c(-Inf, 1.5, 2.5, 3.5, 4.5, 5.5, 6.5, 7.5, 8.5, 9.5, 10.5, Inf)
  idx  <- findInterval(duration_years, brks, left.open = TRUE)

  m6 <- c(9.74,9.59,9.35,9.08,8.83,8.50,8.24,7.97,7.65,7.39,7.18)
  m7 <- c(9.90,9.88,9.77,9.68,9.60,9.45,9.33,9.21,9.09,8.92,8.79)
  m8 <- c(9.97,9.97,9.92,9.88,9.86,9.81,9.76,9.74,9.70,9.61,9.52)

  mm <- dplyr::case_when(
    edss == 6 ~ m6[pmax(1, pmin(idx, length(m6)))],
    edss == 7 ~ m7[pmax(1, pmin(idx, length(m7)))],
    edss == 8 ~ m8[pmax(1, pmin(idx, length(m8)))],
    TRUE ~ NA_real_
  )
  mm
}

smoking_status <- function(sm3, sm5) {
  dplyr::case_when(
    sm3 == 0 ~ "Never Smoker",
    sm3 == 1 & sm5 == 0 ~ "Former Smoker",
    sm3 == 1 & sm5 == 1 ~ "Current Smoker",
    TRUE ~ NA_character_
  )
}
```

---

# 3. Synthetic Data
```{r simulate}
n <- 500
set.seed(params$seed)

cati_subset <- tibble(
  STUDY_ID = seq_len(n),
  GENDER = sample(c("M","F"), n, TRUE),
  BIRTHDATE = as.Date("1955-01-01") + sample(0:20000, n, TRUE),
  VER_INTERVIEW_DATE = BIRTHDATE + years(sample(18:65, n, TRUE)),
  ER1 = rbinom(n, 1, 0.10),
  ER3 = rbinom(n, 1, 0.02),
  ER4 = rbinom(n, 1, 0.10),
  ER10= rbinom(n, 1, 0.05),
  ER5 = rbinom(n, 1, 0.12),
  ER6 = rbinom(n, 1, 0.01),
  ER7 = rbinom(n, 1, 0.60),
  SD2 = sample(2:9, n, TRUE),
  SD3 = sample(1:10, n, TRUE),
  SD15= sample(c(1:13, 98, 99), n, TRUE),
  MS20= sample(0:3, n, TRUE),
  SM3 = rbinom(n, 1, 0.5),
  SM5 = rbinom(n, 1, 0.3),
  RELAPSE1 = sample(c(0,1,98), n, TRUE),
  RCA1B_YEAR = year(VER_INTERVIEW_DATE) - sample(0:30, n, TRUE)
)

subset_iclic_first_analytic <- tibble(
  STUDY_ID = seq_len(n),
  SELF_CATH = rbinom(n, 1, 0.1),
  EDSS_SCALE3 = runif(n, 0, 10),
  CUR_WORK_STATUS = sample(0:1, n, TRUE),
  RELAPSE3 = sample(0:1, n, TRUE),
  RELAPSE_CURRENT = sample(0:1, n, TRUE)
)

subset_iclic_first_cog <- tibble(
  STUDY_ID = seq_len(n),
  EDSS_1 = rbinom(n, 1, 0.2),
  EDSS_2 = rbinom(n, 1, 0.2),
  EDSS_SCALE3 = runif(n, 0, 10),
  RELAPSE4 = sample(0:1, n, TRUE),
  SDMT_R_attempted = rbinom(n, 1, 0.95),
  SDMT_R_correct = round(rnorm(n, 45, 10)),
  DATSTAT_STARTDATETIME = as.Date("2018-01-01") + sample(0:2000, n, TRUE)
)

filtered_ICLIC_geno <- tibble(
  STUDY_ID = seq_len(n),
  SNP1_AA = rbinom(n, 2, 0.3),
  SNP2_AA = rbinom(n, 2, 0.4)
)

cvlt_trials <- paste0("q", 1:16, ".trial_", rep(1:5, each = 16))
cvlt_scores <- matrix(pmax(round(rnorm(n * length(unique(cvlt_trials)), 3, 1)), 0),
                      nrow = n, ncol = length(unique(cvlt_trials)))
colnames(cvlt_scores) <- paste0("q", 1:16, ".trial_", 1:5)
cvlt_df <- as_tibble(cvlt_scores) |> mutate(STUDY_ID = seq_len(n))

SDMT_unique <- tibble(
  STUDY_ID = seq_len(n),
  `SDMT Score` = round(rnorm(n, 48, 10))
)
```

---

# 4. Merge & Derive Outcomes
```{r merge}
geno_iclic_merge <- filtered_ICLIC_geno %>%
  inner_join(subset_iclic_first_cog, by = "STUDY_ID") %>%
  left_join(subset_iclic_first_analytic, by = "STUDY_ID") %>%
  left_join(cati_subset, by = "STUDY_ID")

full_cvlt_scores <- cvlt_df %>% select(STUDY_ID, dplyr::matches("q\\d+\\.trial_\\d+"))
FINAL_MS_SEVERITY <- geno_iclic_merge %>%
  inner_join(full_cvlt_scores, by = "STUDY_ID") %>%
  left_join(SDMT_unique, by = "STUDY_ID")

FINAL_MS_SEVERITY <- FINAL_MS_SEVERITY %>%
  rowwise() %>%
  mutate(`CVLT Total Score` = sum(c_across(matches("^q\\d+\\.trial_\\d+$")), na.rm = TRUE)) %>%
  ungroup()

edss_tbl <- edss_from_ms20(FINAL_MS_SEVERITY$MS20)
FINAL_MS_SEVERITY <- bind_cols(FINAL_MS_SEVERITY, edss_tbl)

FINAL_MS_SEVERITY <- FINAL_MS_SEVERITY %>%
  mutate(
    birth_year = year(BIRTHDATE),
    `Age at Onset` = pmax(RCA1B_YEAR - birth_year, 0),
    `Age at Interview` = round(time_length(interval(BIRTHDATE, DATSTAT_STARTDATETIME), "years"), 1),
    disease_duration = pmax(year(DATSTAT_STARTDATETIME) - RCA1B_YEAR, 0)
  ) %>%
  mutate(
    edss_num = case_when(edss_label == "6" ~ 6,
                         edss_label == "7" ~ 7,
                         edss_label == "8" ~ 8,
                         TRUE ~ NA_real_),
    MSSS_demo = msss_from_edss_duration(edss_num, disease_duration)
  )
```

---

# 5. Covariate Recodes
```{r recodes}
FINAL_MS_SEVERITY <- FINAL_MS_SEVERITY %>%
  mutate(sm_status = smoking_status(SM3, SM5)) %>%
  mutate(sm_status = factor(sm_status, levels = c("Never Smoker","Former Smoker","Current Smoker"))) %>%
  mutate(
    race = case_when(
      ER1 == 1 ~ "Latino/Hispanic",
      ER3 == 1 ~ "American Indian/Alaskan Native",
      ER10== 1 ~ "South Asian",
      ER4 == 1 ~ "Asian",
      ER5 == 1 ~ "Black/African American/African",
      ER6 == 1 ~ "Native Hawaiian/Other Pacific Islander",
      ER7 == 1 ~ "White/Caucasian",
      TRUE ~ NA_character_
    ),
    income = case_when(
      SD15 %in% 1:8 ~ "Up to $50,000",
      SD15 %in% 9:12 ~ "$50,000 - $200,000",
      SD15 == 13 ~ "$200,000+",
      SD15 %in% c(98,99) ~ "Refuse or Don't Know",
      TRUE ~ NA_character_
    ),
    education = case_when(
      SD2 %in% 2:3 ~ "High school or less",
      SD2 %in% 4:9 ~ "Some college or more",
      TRUE ~ NA_character_
    ),
    employment = case_when(
      SD3 == 1 ~ "Employed",
      SD3 %in% 2:10 ~ "Unemployed",
      TRUE ~ NA_character_
    ),
    relapse_last_month = case_when(
      RELAPSE1 %in% c(0,98) ~ "No",
      RELAPSE1 == 1 ~ "Yes",
      TRUE ~ NA_character_
    )
  )
```

---

# 6. Restrict & View
```{r restrict}
analysis_df <- FINAL_MS_SEVERITY %>%
  select(
    STUDY_ID, GENDER, race, `Age at Interview`, `Age at Onset`,
    `SDMT Score`, `CVLT Total Score`, edss_label, disease_duration, MSSS_demo,
    sm_status, income, education, employment, relapse_last_month
  ) %>%
  filter(!is.na(`SDMT Score`), !is.na(`CVLT Total Score`), !is.na(`Age at Onset`))

head(analysis_df, 10) %>% kable() %>% kable_styling(full_width = FALSE)
```

---

# 7. Summary Table
```{r summary}
analysis_df %>%
  group_by(sm_status) %>%
  summarise(
    n = n(),
    mean_SDMT = mean(`SDMT Score`, na.rm = TRUE),
    mean_CVLT = mean(`CVLT Total Score`, na.rm = TRUE),
    mean_age_interview = mean(`Age at Interview`, na.rm = TRUE)
  ) %>%
  kable(digits = 2) %>%
  kable_styling(full_width = FALSE)
```

---

# 8. Reproducibility
- All data are synthetic, generated within this document.
- To re-run with a different seed:
```r
rmarkdown::render("vignettes/ms_severity_wrangling.Rmd", params = list(seed = 2025))
```

```{r}
sessionInfo()
```
